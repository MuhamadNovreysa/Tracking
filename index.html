<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Genius | Pelacak Keuangan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>

    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
            --success-color: #1cc88a;
            --info-color: #36b9cc;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
            --light-color: #f8f9fc;
            --dark-color: #2c3e50;
            --background-color: #e9ecef;
            --card-bg: #ffffff;
            --sidebar-width: 260px;
            --sidebar-collapsed-width: 80px;
            --topbar-height: 56px;
            --gradient-bg: linear-gradient(135deg, #6e8efb 0%, #a777e3 100%);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            --shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.2);
            --border-radius: 12px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--gradient-bg);
            color: var(--dark-color);
            margin: 0;
            overflow-x: hidden;
            line-height: 1.6;
        }

        /* Stabilkan ukuran chart dan hapus animasi */
        .card, .card-body, #spendingChart, #categoryChart, #comparisonChart, #trendChart {
            animation: none !important;
            transition: none !important;
            transform: none !important;
            opacity: 1 !important;
        }

        /* Login & Register Modal */
        #loginModal .modal-content, #registerModal .modal-content {
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            background: linear-gradient(145deg, #ffffff, #f1f4f8);
            border: none;
        }

        #loginModal .modal-header, #registerModal .modal-header {
            border-bottom: none;
            padding: 1.5rem 2rem;
            background: transparent;
        }

        #loginModal .modal-body, #registerModal .modal-body {
            padding: 1.5rem 2rem;
        }

        .btn-link {
            text-decoration: none;
            color: var(--primary-color);
            font-weight: 600;
        }

        .btn-link:hover {
            color: #2e59d9;
        }

        /* Sidebar Toggle Button */
        .sidebar-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1100;
            font-size: 1.5rem;
            color: #ffffff;
            background: var(--primary-color);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease, background-color 0.3s ease;
        }

        .sidebar-toggle:hover {
            background: #2e59d9;
            transform: scale(1.1);
        }

        /* Sidebar Styles */
        .sidebar {
            background: linear-gradient(180deg, var(--primary-color) 0%, #2c3e50 100%);
            color: #ffffff;
            height: 100vh;
            width: var(--sidebar-width);
            position: fixed;
            top: 0;
            left: 0;
            padding: 0;
            z-index: 1000;
            overflow-y: auto;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease-in-out;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 2rem 1.5rem 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-info {
            font-size: 0.9rem;
            opacity: 0.85;
            color: #dfe6e9;
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.85);
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-left: 4px solid transparent;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
        }

        .sidebar .nav-link:hover {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.15);
            border-left-color: #ffffff;
            transform: translateX(5px);
        }

        .sidebar .nav-link.active {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.25);
            border-left-color: #ffffff;
        }

        .sidebar .nav-link i {
            font-size: 1.2rem;
        }

        .sidebar .nav {
            padding-bottom: 1.5rem;
        }

        .sidebar-footer {
            padding: 1.5rem;
            width: 100%;
        }

        .btn-export, .btn-logout {
            width: 100%;
            padding: 0.75rem;
            font-weight: 600;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
        }

        .btn-export {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #ffffff;
        }

        .btn-export:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn-logout {
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
        }

        .btn-logout:hover {
            background: var(--danger-color);
            color: #ffffff;
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        /* Main Content Styles */
        main {
            margin-left: 0;
            padding: 2rem;
            transition: margin-left 0.3s ease-in-out;
            background: transparent;
        }

        /* Summary Cards */
        .summary-card {
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            background: var(--card-bg);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .summary-card .card-body {
            padding: 1.5rem;
        }

        .summary-card .card-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
        }

        .summary-card .card-amount {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--dark-color);
        }

        .summary-card i {
            font-size: 2.5rem;
            opacity: 0.4;
        }

        .income-card {
            border-left: 5px solid var(--success-color);
        }

        .expense-card {
            border-left: 5px solid var(--danger-color);
        }

        .balance-card {
            border-left: 5px solid var(--primary-color);
        }

        /* Chart Containers */
        .card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            background: var(--card-bg);
            margin-bottom: 2rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .card-header {
            background: var(--light-color);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding: 1.25rem 1.5rem;
            font-weight: 700;
            color: var(--dark-color);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        /* Tables */
        .table {
            color: var(--dark-color);
            background: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .table th {
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            color: var(--secondary-color);
            background: var(--light-color);
        }

        .table td {
            vertical-align: middle;
        }

        /* AI Insights */
        .insight-container {
            min-height: 200px;
            position: relative;
        }

        .insight-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.9);
            z-index: 10;
            border-radius: var(--border-radius);
        }

        .insight-content {
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .insight-content.show {
            opacity: 1;
        }

        .insight-item {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
        }

        .insight-title {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .insight-text {
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--dark-color);
        }

        /* Financial Score */
        .financial-score {
            margin: 1.5rem 0;
        }

        .score-circle {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: conic-gradient(var(--success-color) 0%, var(--success-color) 0%, #dfe6e9 0%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            position: relative;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }

        .score-circle:hover {
            transform: scale(1.05);
        }

        .score-value {
            font-size: 2.8rem;
            font-weight: 800;
            color: var(--dark-color);
        }

        .score-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--secondary-color);
            text-align: center;
        }

        .score-breakdown .breakdown-item {
            margin-bottom: 1rem;
        }

        .breakdown-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark-color);
            display: block;
            margin-bottom: 0.5rem;
        }

        /* Form Styles */
        .form-control, .form-select {
            padding: 0.75rem;
            font-size: 0.95rem;
            border: 1px solid #dfe6e9;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
        }

        /* Button Styles */
        .btn {
            padding: 0.75rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary-color);
            border: none;
        }

        .btn-primary:hover {
            background: #2e59d9;
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            background: var(--primary-color);
            color: #ffffff;
            transform: translateY(-2px);
        }

        /* Modal Styles */
        .modal-content {
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .modal-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding: 1.5rem 2rem;
        }

        .modal-title {
            font-weight: 700;
            color: var(--dark-color);
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            padding: 1.5rem 2rem;
        }

        /* Category Items */
        .list-group-item {
            padding: 1rem 1.5rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: var(--card-bg);
            transition: transform 0.3s ease;
        }

        .list-group-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .category-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            color: #ffffff;
            font-size: 1.2rem;
        }

        .category-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--dark-color);
        }

        .category-actions .btn {
            padding: 0.5rem;
            font-size: 0.85rem;
            margin-left: 0.5rem;
        }

        /* Transaction Items */
        .transaction-income {
            color: var(--success-color);
            font-weight: 600;
        }

        .transaction-expense {
            color: var(--danger-color);
            font-weight: 600;
        }

        /* Responsive Styles */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
            }
            .sidebar.collapsed {
                transform: translateX(0);
            }
            main {
                margin-left: var(--sidebar-width);
            }
            .sidebar-toggle {
                display: none;
            }
        }

        @media (max-width: 767px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar:not(.collapsed) {
                transform: translateX(0);
            }
            .sidebar:not(.collapsed) + main {
                margin-left: var(--sidebar-width);
            }
            .sidebar.collapsed + main {
                margin-left: 0;
            }
            .summary-card {
                margin-bottom: 1.5rem;
            }
            .row {
                margin-left: -0.75rem;
                margin-right: -0.75rem;
            }
            .col-md-4, .col-md-6, .col-md-8 {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Masuk ke BisDig Tracking</h5>
                </div>
                <div class="modal-body">
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="login-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="login-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="login-password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="login-password" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="remember-me">
                            <label class="form-check-label" for="remember-me">Ingat saya</label>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <button type="submit" class="btn btn-primary">Masuk</button>
                            <button type="button" class="btn btn-link" id="show-register">Daftar Akun Baru</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal fade" id="registerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Daftar Akun Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="register-form">
                        <div class="mb-3">
                            <label for="register-name" class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" id="register-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="register-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="register-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="register-password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="register-password" required>
                        </div>
                        <div class="mb-3">
                            <label for="register-confirm-password" class="form-label">Konfirmasi Password</label>
                            <input type="password" class="form-control" id="register-confirm-password" required>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <button type="submit" class="btn btn-primary">Daftar</button>
                            <button type="button" class="btn btn-link" id="show-login">Sudah punya akun? Masuk</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until login) -->
    <div id="app-container" class="d-none">
        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar Toggle Button (for mobile) -->
                <button class="sidebar-toggle" aria-label="Toggle Sidebar">
                    <i class="bx bx-menu"></i>
                </button>

                <!-- Sidebar -->
                <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block sidebar collapsed">
                    <div class="position-sticky">
                        <div class="sidebar-header">
                            <h3><i class="fas fa-wallet me-2"></i>CashFlow</h3>
                            <div class="user-info">
                                <small id="sidebar-username">Nama Pengguna</small>
                            </div>
                        </div>
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link active" href="#dashboard" aria-current="page">
                                    <i class="fas fa-home me-2"></i>Beranda
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#transaksi">
                                    <i class="fas fa-exchange-alt me-2"></i>Transaksi
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#kategori">
                                    <i class="fas fa-tags me-2"></i>Kategori
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#laporan">
                                    <i class="fas fa-chart-pie me-2"></i>Laporan
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#analisis">
                                    <i class="fas fa-lightbulb me-2"></i>Analisis AI
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#pengaturan">
                                    <i class="fas fa-cog me-2"></i>Pengaturan
                                </a>
                            </li>
                        </ul>
                        <div class="sidebar-footer">
                            <button class="btn btn-primary btn-export" aria-label="Ekspor Data">
                                <i class="fas fa-file-export me-2"></i>Ekspor Data
                            </button>
                            <button class="btn btn-outline-danger btn-logout mt-2" aria-label="Keluar">
                                <i class="fas fa-sign-out-alt me-2"></i>Keluar
                            </button>
                        </div>
                    </div>
                </nav>

                <!-- Main Content -->
                <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2" id="page-title">Beranda</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="time-period">Bulan Ini</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown">
                                    <span class="visually-hidden">Toggle Dropdown</span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item time-period-option" href="#" data-period="today">Hari Ini</a></li>
                                    <li><a class="dropdown-item time-period-option" href="#" data-period="week">Minggu Ini</a></li>
                                    <li><a class="dropdown-item time-period-option" href="#" data-period="month">Bulan Ini</a></li>
                                    <li><a class="dropdown-item time-period-option" href="#" data-period="year">Tahun Ini</a></li>
                                    <li><a class="dropdown-item time-period-option" href="#" data-period="custom">Rentang Kustom</a></li>
                                </ul>
                            </div>
                            <button type="button" class="btn btn-sm btn-success" id="add-transaction-btn">
                                <i class="fas fa-plus me-1"></i> Tambah Transaksi
                            </button>
                        </div>
                    </div>

                    <!-- Dashboard Content -->
                    <div id="dashboard-content" class="page-content">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card summary-card income-card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="card-title">Pemasukan</h6>
                                                <h2 class="card-amount" id="income-amount">Rp0</h2>
                                            </div>
                                            <i class="fas fa-arrow-down"></i>
                                        </div>
                                        <div class="progress mt-3">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="income-progress"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card summary-card expense-card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="card-title">Pengeluaran</h6>
                                                <h2 class="card-amount" id="expense-amount">Rp0</h2>
                                            </div>
                                            <i class="fas fa-arrow-up"></i>
                                        </div>
                                        <div class="progress mt-3">
                                            <div class="progress-bar bg-danger" role="progressbar" style="width: 0%" id="expense-progress"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card summary-card balance-card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="card-title">Saldo</h6>
                                                <h2 class="card-amount" id="balance-amount">Rp0</h2>
                                            </div>
                                            <i class="fas fa-wallet"></i>
                                        </div>
                                        <div class="progress mt-3">
                                            <div class="progress-bar bg-primary" role="progressbar" style="width: 0%" id="balance-progress"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Ringkasan Pengeluaran</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="spendingChart" height="250"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Distribusi Kategori</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="categoryChart" height="250"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Transaksi Terakhir</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Tanggal</th>
                                                        <th>Keterangan</th>
                                                        <th>Jumlah</th>
                                                        <th>Kategori</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="recent-transactions">
                                                    <!-- Transaksi akan dimuat di sini -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Analisis Keuangan</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="insight-container">
                                            <div class="insight-loading">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p>Menganalisis data keuangan Anda...</p>
                                            </div>
                                            <div class="insight-content" id="ai-insights">
                                                <!-- Analisis akan dimuat di sini -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Transactions Content -->
                    <div id="transaksi-content" class="page-content d-none">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4>Semua Transaksi</h4>
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    Filter
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item filter-option" href="#" data-filter="all">Semua</a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-filter="income">Pemasukan</a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-filter="expense">Pengeluaran</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-filter="category">Berdasarkan Kategori</a></li>
                                </ul>
                                <button class="btn btn-outline-secondary btn-sm" id="sort-transactions">
                                    <i class="fas fa-sort-amount-down"></i> Urutkan
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Keterangan</th>
                                        <th>Kategori</th>
                                        <th>Jumlah</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="all-transactions">
                                    <!-- Semua transaksi akan dimuat di sini -->
                                </tbody>
                            </table>
                        </div>
                        <nav aria-label="Transaction pagination">
                            <ul class="pagination justify-content-center" id="transaction-pagination">
                                <!-- Pagination akan dimuat di sini -->
                            </ul>
                        </nav>
                    </div>

                    <!-- Categories Content -->
                    <div id="kategori-content" class="page-content d-none">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4>Kategori</h4>
                            <button class="btn btn-primary" id="add-category-btn">
                                <i class="fas fa-plus me-1"></i> Tambah Kategori
                            </button>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header bg-success text-white">
                                        <h5>Kategori Pemasukan</h5>
                                    </div>
                                    <div class="card-body">
                                        <ul class="list-group" id="income-categories">
                                            <!-- Kategori pemasukan akan dimuat di sini -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header bg-danger text-white">
                                        <h5>Kategori Pengeluaran</h5>
                                    </div>
                                    <div class="card-body">
                                        <ul class="list-group" id="expense-categories">
                                            <!-- Kategori pengeluaran akan dimuat di sini -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reports Content -->
                    <div id="laporan-content" class="page-content d-none">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4>Laporan Keuangan</h4>
                            <div class="btn-group">
                                <button class="btn btn-outline-primary" id="export-report-btn">
                                    <i class="fas fa-file-export me-1"></i> Ekspor Laporan
                                </button>
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Perbandingan Periode</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <select class="form-select" id="report-period-1">
                                                    <option value="this_month">Bulan Ini</option>
                                                    <option value="last_month">Bulan Lalu</option>
                                                    <option value="this_quarter">Kuartal Ini</option>
                                                    <option value="last_quarter">Kuartal Lalu</option>
                                                    <option value="this_year">Tahun Ini</option>
                                                    <option value="last_year">Tahun Lalu</option>
                                                    <option value="custom">Kustom</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <select class="form-select" id="report-period-2">
                                                    <option value="last_month">Bulan Lalu</option>
                                                    <option value="this_month">Bulan Ini</option>
                                                    <option value="last_quarter">Kuartal Lalu</option>
                                                    <option value="this_quarter">Kuartal Ini</option>
                                                    <option value="last_year">Tahun Lalu</option>
                                                    <option value="this_year">Tahun Ini</option>
                                                    <option value="custom">Kustom</option>
                                                </select>
                                            </div>
                                        </div>
                                        <canvas id="comparisonChart" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Tren Kategori</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <select class="form-select" id="category-trend-select">
                                                <!-- Kategori akan dimuat di sini -->
                                            </select>
                                        </div>
                                        <canvas id="trendChart" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h5>Laporan Detail</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Kategori</th>
                                                <th>Bulan Ini</th>
                                                <th>Bulan Lalu</th>
                                                <th>Perubahan</th>
                                                <th>% dari Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="detailed-report">
                                            <!-- Data laporan akan dimuat di sini -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Insights Content -->
                    <div id="analisis-content" class="page-content d-none">
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Analisis Kesehatan Keuangan</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="insight-container">
                                            <div class="insight-loading">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p>Menganalisis kesehatan keuangan Anda...</p>
                                            </div>
                                            <div class="insight-content" id="financial-health-insights">
                                                <!-- Analisis akan dimuat di sini -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Skor Keuangan</h5>
                                    </div>
                                    <div class="card-body text-center">
                                        <div class="financial-score">
                                            <div class="score-circle">
                                                <div class="score-value" id="financial-score">--</div>
                                            </div>
                                            <div class="score-label">Kesehatan Keuangan Keseluruhan</div>
                                        </div>
                                        <div class="score-breakdown mt-3">
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">Tabungan</span>
                                                <div class="progress">
                                                    <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="savings-score"></div>
                                                </div>
                                            </div>
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">Pengeluaran</span>
                                                <div class="progress">
                                                    <div class="progress-bar bg-info" role="progressbar" style="width: 0%" id="spending-score"></div>
                                                </div>
                                            </div>
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">Anggaran</span>
                                                <div class="progress">
                                                    <div class="progress-bar bg-warning" role="progressbar" style="width: 0%" id="budgeting-score"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5>Rekomendasi Personal</h5>
                                    <button class="btn btn-sm btn-outline-primary" id="refresh-insights">
                                        <i class="fas fa-sync-alt me-1"></i> Segarkan
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="insight-container">
                                    <div class="insight-loading">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p>Membuat rekomendasi personal...</p>
                                    </div>
                                    <div class="insight-content" id="recommendations-insights">
                                        <!-- Rekomendasi akan dimuat di sini -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Content -->
                    <div id="pengaturan-content" class="page-content d-none">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5>Pengaturan Akun</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="account-settings-form">
                                            <div class="mb-3">
                                                <label for="user-name" class="form-label">Nama</label>
                                                <input type="text" class="form-control" id="user-name">
                                            </div>
                                            <div class="mb-3">
                                                <label for="user-email" class="form-label">Email</label>
                                                <input type="email" class="form-control" id="user-email">
                                            </div>
                                            <div class="mb-3">
                                                <label for="user-currency" class="form-label">Mata Uang</label>
                                                <select class="form-select" id="user-currency">
                                                    <option value="IDR">Rupiah (Rp)</option>
                                                    <option value="USD">Dolar AS ($)</option>
                                                    <option value="EUR">Euro (€)</option>
                                                    <option value="GBP">Pound Sterling (£)</option>
                                                    <option value="JPY">Yen Jepang (¥)</option>
                                                </select>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5>Pengaturan Anggaran</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="budget-settings-form">
                                            <div class="mb-3">
                                                <label for="monthly-budget" class="form-label">Anggaran Bulanan</label>
                                                <input type="number" class="form-control" id="monthly-budget" min="0" step="1000">
                                            </div>
                                            <div class="mb-3">
                                                <label for="savings-goal" class="form-label">Target Tabungan (%)</label>
                                                <input type="number" class="form-control" id="savings-goal" min="0" max="100" step="1">
                                            </div>
                                            <div class="mb-3 form-check">
                                                <input type="checkbox" class="form-check-input" id="notifications-enabled">
                                                <label class="form-check-label" for="notifications-enabled">Aktifkan Notifikasi</label>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Simpan Pengaturan</button>
                                        </form>
                                    </div>
                                </div>
                                <div class="card">
                                    <div class="card-header bg-danger text-white">
                                        <h5>Zona Bahaya</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <button class="btn btn-outline-danger" id="export-all-data">
                                                <i class="fas fa-file-export me-1"></i> Ekspor Semua Data
                                            </button>
                                            <small class="text-muted d-block mt-1">Unduh cadangan semua data Anda</small>
                                        </div>
                                        <div class="mb-3">
                                            <button class="btn btn-outline-danger" id="reset-all-data">
                                                <i class="fas fa-trash-alt me-1"></i> Hapus Semua Data
                                            </button>
                                            <small class="text-muted d-block mt-1">Hapus permanen semua data Anda</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div class="modal fade" id="transactionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transactionModalTitle">Tambah Transaksi Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="transaction-form">
                        <div class="mb-3">
                            <label for="transaction-type" class="form-label">Jenis</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="transaction-type" id="type-income" value="income" autocomplete="off" checked>
                                <label class="btn btn-outline-success" for="type-income">Pemasukan</label>
                                <input type="radio" class="btn-check" name="transaction-type" id="type-expense" value="expense" autocomplete="off">
                                <label class="btn btn-outline-danger" for="type-expense">Pengeluaran</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="transaction-amount" class="form-label">Jumlah</label>
                            <div class="input-group">
                                <span class="input-group-text">Rp</span>
                                <input type="number" class="form-control" id="transaction-amount" min="0" step="100" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="transaction-description" class="form-label">Keterangan</label>
                            <input type="text" class="form-control" id="transaction-description" required>
                        </div>
                        <div class="mb-3">
                            <label for="transaction-category" class="form-label">Kategori</label>
                            <select class="form-select" id="transaction-category" required>
                                <!-- Kategori akan dimuat di sini -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="transaction-date" class="form-label">Tanggal</label>
                            <input type="date" class="form-control" id="transaction-date" required>
                        </div>
                        <input type="hidden" id="transaction-id">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="save-transaction">Simpan Transaksi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div class="modal fade" id="categoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalTitle">Tambah Kategori Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="category-form">
                        <div class="mb-3">
                            <label for="category-name" class="form-label">Nama Kategori</label>
                            <input type="text" class="form-control" id="category-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="category-type" class="form-label">Jenis</label>
                            <select class="form-select" id="category-type" required>
                                <option value="income">Pemasukan</option>
                                <option value="expense">Pengeluaran</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="category-icon" class="form-label">Ikon</label>
                            <select class="form-select" id="category-icon" required>
                                <option value="shopping-cart">Belanja</option>
                                <option value="utensils">Makanan</option>
                                <option value="home">Perumahan</option>
                                <option value="car">Transportasi</option>
                                <option value="tv">Hiburan</option>
                                <option value="heart">Kesehatan</option>
                                <option value="graduation-cap">Pendidikan</option>
                                <option value="gift">Hadiah</option>
                                <option value="money-bill-wave">Gaji</option>
                                <option value="business-time">Bisnis</option>
                                <option value="piggy-bank">Tabungan</option>
                                <option value="dollar-sign">Lainnya</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="category-color" class="form-label">Warna</label>
                            <input type="color" class="form-control form-control-color" id="category-color" value="#563d7c" title="Pilih warna">
                        </div>
                        <input type="hidden" id="category-id">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="save-category">Simpan Kategori</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Date Range Modal -->
    <div class="modal fade" id="dateRangeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pilih Rentang Tanggal Kustom</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="date-range-form">
                        <div class="mb-3">
                            <label for="start-date" class="form-label">Tanggal Mulai</label>
                            <input type="date" class="form-control" id="start-date" required>
                        </div>
                        <div class="mb-3">
                            <label for="end-date" class="form-label">Tanggal Selesai</label>
                            <input type="date" class="form-control" id="end-date" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="apply-date-range">Terapkan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalTitle">Konfirmasi Aksi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmationModalBody">
                    Apakah Anda yakin ingin melakukan aksi ini?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-danger" id="confirm-action">Konfirmasi</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <script>
        // Minimal JS untuk toggle sidebar di mobile
        document.querySelector('.sidebar-toggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });
    </script>
    <script>
      // Initialize Firebase


const firebaseConfig = {
  apiKey: "AIzaSyD1B_aBIvhatHtK9vEOq_00Wx55HOB53FI",
  authDomain: "tracking2-95ed5.firebaseapp.com",
  databaseURL: "https://tracking2-95ed5-default-rtdb.firebaseio.com", 
  projectId: "tracking2-95ed5",
  storageBucket: "tracking2-95ed5.firebasestorage.app",
  messagingSenderId: "28636122127",
  appId: "1:28636122127:web:38c89c6fc2abb75fbbe77a",
  measurementId: "G-4NHDRNJE8F"
};
        // Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const analytics = getAnalytics(app);

// Tampilkan modal login saat halaman dimuat
document.addEventListener('DOMContentLoaded', function() {
  const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
  loginModal.show();
});

// DOM Elements
const appContainer = document.getElementById('app-container');
const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
const registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
const loginForm = document.getElementById('login-form');
const registerForm = document.getElementById('register-form');
const showRegisterBtn = document.getElementById('show-register');
const showLoginBtn = document.getElementById('show-login');
const logoutBtn = document.querySelector('.btn-logout');

const sidebar = document.getElementById('sidebar');
const mainContent = document.querySelector('main');
const pageContents = document.querySelectorAll('.page-content');
const navLinks = document.querySelectorAll('.nav-link');
const pageTitle = document.getElementById('page-title');
const addTransactionBtn = document.getElementById('add-transaction-btn');
const transactionModal = new bootstrap.Modal(document.getElementById('transactionModal'));
const transactionForm = document.getElementById('transaction-form');
const saveTransactionBtn = document.getElementById('save-transaction');
const addCategoryBtn = document.getElementById('add-category-btn');
const categoryModal = new bootstrap.Modal(document.getElementById('categoryModal'));
const categoryForm = document.getElementById('category-form');
const saveCategoryBtn = document.getElementById('save-category');
const timePeriodBtn = document.getElementById('time-period');
const timePeriodOptions = document.querySelectorAll('.time-period-option');
const dateRangeModal = new bootstrap.Modal(document.getElementById('dateRangeModal'));
const applyDateRangeBtn = document.getElementById('apply-date-range');
const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
const confirmActionBtn = document.getElementById('confirm-action');
const exportAllDataBtn = document.getElementById('export-all-data');
const exportReportBtn = document.getElementById('export-report-btn');
const refreshInsightsBtn = document.getElementById('refresh-insights');
const resetAllDataBtn = document.getElementById('reset-all-data');
const accountSettingsForm = document.getElementById('account-settings-form');
const budgetSettingsForm = document.getElementById('budget-settings-form');

// Chart instances
let spendingChart, categoryChart, comparisonChart, trendChart;

// App State
let state = {
    currentUser: null,
    users: {},
    transactions: [],
    categories: [],
    currentPeriod: 'month',
    currentPage: 'dashboard',
    editingTransaction: null,
    editingCategory: null
};

// Initialize the app
function init() {
    // Coba load dari localStorage dulu
    const savedState = localStorage.getItem('appState');
    if (savedState) {
        state = JSON.parse(savedState);
        if (state.currentUser) {
            loginUser(state.currentUser);
            return;
        }
    }

    // Kalau ga ada di localStorage, cek Firebase
    const rememberedEmail = localStorage.getItem('rememberedEmail');
    if (rememberedEmail) {
        checkUserExists(rememberedEmail, (exists) => {
            if (exists) {
                loginUser(rememberedEmail);
            } else {
                localStorage.removeItem('rememberedEmail');
                loginModal.show();
            }
        });
    } else {
        loginModal.show();
    }

    setupEventListeners();
}

// Check if user exists in Firebase
function checkUserExists(email, callback) {
    database.ref('users/' + encodeEmail(email)).once('value')
        .then((snapshot) => {
            callback(snapshot.exists());
        })
        .catch((error) => {
            console.error('Error checking user:', error);
            callback(false); // Default ke false kalau error
        });
}

// Encode email for Firebase key
function encodeEmail(email) {
    return email.replace(/\./g, ',');
}

// Decode email from Firebase key
function decodeEmail(encodedEmail) {
    return encodedEmail.replace(/,/g, '.');
}

// Load user data from Firebase
function loadUserData(email, callback) {
    const encodedEmail = encodeEmail(email);
    
    database.ref('users/' + encodedEmail).once('value')
        .then((snapshot) => {
            const userData = snapshot.val();
            if (userData) {
                // Initialize default categories if none exist
                if (!userData.categories) {
                    userData.categories = getDefaultCategories();
                    database.ref('users/' + encodedEmail + '/categories').set(userData.categories);
                }
                callback(userData);
            } else {
                callback(null);
            }
        })
        .catch((error) => {
            console.error('Error loading user data:', error);
            alert('Gagal memuat data pengguna. Periksa koneksi internet Anda.');
            callback(null);
        });
}

// Get default categories
function getDefaultCategories() {
    return [
        { id: 1, name: 'Gaji', type: 'income', icon: 'money-bill-wave', color: '#28a745' },
        { id: 2, name: 'Freelance', type: 'income', icon: 'laptop-code', color: '#17a2b8' },
        { id: 3, name: 'Makanan', type: 'expense', icon: 'utensils', color: '#dc3545' },
        { id: 4, name: 'Transportasi', type: 'expense', icon: 'bus', color: '#fd7e14' },
        { id: 5, name: 'Hiburan', type: 'expense', icon: 'film', color: '#6f42c1' },
        { id: 6, name: 'Sewa Rumah', type: 'expense', icon: 'home', color: '#343a40' }
    ];
}

// Save user data to Firebase
function saveUserData(email, data) {
    const encodedEmail = encodeEmail(email);
    return database.ref('users/' + encodedEmail).set(data);
}

// Save state to localStorage and sync to Firebase
function saveToLocalStorage() {
    localStorage.setItem('appState', JSON.stringify(state));
    if (state.currentUser) {
        saveUserData(state.currentUser, state.users[state.currentUser]);
    }
}

// Setup event listeners
function setupEventListeners() {
    // Login/Register
    loginForm.addEventListener('submit', handleLogin);
    registerForm.addEventListener('submit', handleRegister);
    showRegisterBtn.addEventListener('click', () => {
        loginModal.hide();
        registerModal.show();
    });
    showLoginBtn.addEventListener('click', () => {
        registerModal.hide();
        loginModal.show();
    });
    logoutBtn.addEventListener('click', handleLogout);

    // Navigation
    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const page = link.getAttribute('href').substring(1);
            showPage(page);
        });
    });

    // Transactions
    addTransactionBtn.addEventListener('click', () => {
        state.editingTransaction = null;
        transactionForm.reset();
        document.getElementById('transactionModalTitle').textContent = 'Tambah Transaksi Baru';
        document.getElementById('transaction-date').value = formatDate(new Date());
        renderCategoriesDropdown();
        transactionModal.show();
    });

    saveTransactionBtn.addEventListener('click', saveTransaction);

    // Categories
    addCategoryBtn.addEventListener('click', () => {
        state.editingCategory = null;
        categoryForm.reset();
        document.getElementById('categoryModalTitle').textContent = 'Tambah Kategori Baru';
        categoryModal.show();
    });

    saveCategoryBtn.addEventListener('click', saveCategory);

    // Time period
    timePeriodOptions.forEach(option => {
        option.addEventListener('click', (e) => {
            e.preventDefault();
            const period = option.getAttribute('data-period');
            if (period === 'custom') {
                dateRangeModal.show();
            } else {
                state.currentPeriod = period;
                timePeriodBtn.textContent = option.textContent;
                updateDashboard();
                renderRecentTransactions();
                renderAllTransactions();
            }
        });
    });

    applyDateRangeBtn.addEventListener('click', () => {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        if (startDate && endDate) {
            state.currentPeriod = { start: startDate, end: endDate };
            timePeriodBtn.textContent = `${formatDisplayDate(startDate)} - ${formatDisplayDate(endDate)}`;
            updateDashboard();
            renderRecentTransactions();
            renderAllTransactions();
            dateRangeModal.hide();
        }
    });

    // Export data
    exportAllDataBtn.addEventListener('click', exportAllData);
    exportReportBtn.addEventListener('click', exportReport);

    // Reset data
    resetAllDataBtn.addEventListener('click', () => {
        showConfirmation(
            'Hapus Semua Data',
            'Apakah Anda yakin ingin menghapus semua data? Aksi ini tidak dapat dibatalkan.',
            resetAllData
        );
    });

    // Refresh insights
    refreshInsightsBtn.addEventListener('click', generateInsights);

    // Settings forms
    accountSettingsForm.addEventListener('submit', saveAccountSettings);
    budgetSettingsForm.addEventListener('submit', saveBudgetSettings);

    document.getElementById('loginModal').addEventListener('hidden.bs.modal', function () {
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
    });
}

// Handle login
function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    const rememberMe = document.getElementById('remember-me').checked;

    // Check if user exists in Firebase
    checkUserExists(email, (exists) => {
        if (!exists) {
            alert('Email tidak terdaftar');
            return;
        }

        // Load user data
        loadUserData(email, (userData) => {
            if (!userData) {
                alert('Terjadi kesalahan saat memuat data pengguna');
                return;
            }

            if (userData.password !== password) {
                alert('Password salah');
                return;
            }

            if (rememberMe) {
                localStorage.setItem('rememberedEmail', email);
            } else {
                localStorage.removeItem('rememberedEmail');
            }

            loginUser(email);
        });
    });
}

// Handle register
function handleRegister(e) {
    e.preventDefault();
    const name = document.getElementById('register-name').value;
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    const confirmPassword = document.getElementById('register-confirm-password').value;

    if (password !== confirmPassword) {
        alert('Password dan konfirmasi password tidak cocok');
        return;
    }

    // Check if user already exists
    checkUserExists(email, (exists) => {
        if (exists) {
            alert('Email sudah terdaftar');
            return;
        }

        // Create new user data
        const userData = {
            name,
            email,
            password,
            currency: 'IDR',
            monthlyBudget: 0,
            savingsGoal: 20,
            notificationsEnabled: true,
            transactions: [],
            categories: getDefaultCategories()
        };

        // Save to Firebase
        saveUserData(email, userData)
            .then(() => {
                registerModal.hide();
                loginUser(email);
            })
            .catch((error) => {
                console.error('Error saving user data:', error);
                alert('Terjadi kesalahan saat mendaftar. Silakan coba lagi.');
            });
    });
}

// Login user
function loginUser(email) {
    loadUserData(email, (userData) => {
        if (!userData) {
            alert('Terjadi kesalahan saat memuat data pengguna');
            return;
        }

        state.currentUser = email;
        state.users[email] = userData;
        state.transactions = userData.transactions || [];
        state.categories = userData.categories || getDefaultCategories();

        // Update UI
        document.getElementById('sidebar-username').textContent = userData.name;
        const appContainer = document.getElementById('app-container');
        const sidebar = document.getElementById('sidebar');
        if (appContainer) {
            appContainer.classList.remove('d-none');
        } else {
            console.error('app-container not found in DOM!');
        }
        if (sidebar) {
            sidebar.classList.add('active'); // Ini yang bikin sidebar muncul di layar kecil
        } else {
            console.error('sidebar not found in DOM!');
        }

        // Pastikan modal ditutup dan backdrop dihapus dengan log
        console.log('Hiding login modal...');
        loginModal.hide();
        console.log('Modal hidden, removing backdrop...');
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
        console.log('Backdrop removed, resetting body...');
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        console.log('Body reset, UI initialized');

        // Initialize UI dan pindah ke dashboard
        renderCategoriesDropdown();
        renderAllCategories();
        updateDashboard();
        renderRecentTransactions();
        renderAllTransactions();
        renderUserSettings();
        showPage('dashboard');
    });
}

// Handle logout
function handleLogout() {
    state.currentUser = null;
    localStorage.removeItem('appState'); // Hapus data di localStorage
    appContainer.classList.add('d-none');
    loginModal.show();
}

// Show specific page content
function showPage(page) {
    state.currentPage = page;
    
    // Update active nav link
    navLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('href').substring(1) === page) {
            link.classList.add('active');
        }
    });

    // Hide all page contents
    pageContents.forEach(content => {
        content.classList.add('d-none');
    });

    // Show selected page content
    document.getElementById(`${page}-content`).classList.remove('d-none');
    
    // Update page title
    const pageTitles = {
        'dashboard': 'Beranda',
        'transaksi': 'Transaksi',
        'kategori': 'Kategori',
        'laporan': 'Laporan',
        'analisis': 'Analisis',
        'pengaturan': 'Pengaturan'
    };
    pageTitle.textContent = pageTitles[page];
    
    // Page-specific initializations
    switch (page) {
        case 'dashboard':
            updateDashboard();
            break;
        case 'transaksi':
            renderAllTransactions();
            break;
        case 'kategori':
            renderAllCategories();
            break;
        case 'laporan':
            renderReports();
            break;
        case 'analisis':
            generateInsights();
            break;
        case 'pengaturan':
            renderUserSettings();
            break;
    }
}

// Format date as YYYY-MM-DD
function formatDate(date) {
    const d = new Date(date);
    let month = '' + (d.getMonth() + 1);
    let day = '' + d.getDate();
    const year = d.getFullYear();

    if (month.length < 2) month = '0' + month;
    if (day.length < 2) day = '0' + day;

    return [year, month, day].join('-');
}

// Format date for display (e.g., 1 Jan 2023)
function formatDisplayDate(dateStr) {
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return new Date(dateStr).toLocaleDateString('id-ID', options);
}

// Format currency
function formatCurrency(amount) {
    if (state.users[state.currentUser].currency === 'IDR') {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
    } else {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: state.users[state.currentUser].currency }).format(amount);
    }
}

// Save transaction
function saveTransaction() {
    const amount = parseFloat(document.getElementById('transaction-amount').value);
    const description = document.getElementById('transaction-description').value.trim();
    const categoryId = parseInt(document.getElementById('transaction-category').value);
    const date = document.getElementById('transaction-date').value;
    const type = document.querySelector('input[name="transaction-type"]:checked').value;
    
    if (!amount || !description || !categoryId || !date) {
        alert('Harap isi semua field');
        return;
    }

    const transactionData = {
        amount,
        description,
        categoryId,
        date,
        type
    };

    if (state.editingTransaction) {
        // Update existing transaction
        transactionData.id = state.editingTransaction.id;
        const index = state.transactions.findIndex(t => t.id === state.editingTransaction.id);
        state.transactions[index] = transactionData;
    } else {
        // Add new transaction
        transactionData.id = state.transactions.length > 0 
            ? Math.max(...state.transactions.map(t => t.id)) + 1 
            : 1;
        state.transactions.push(transactionData);
    }

    // Save to user data
    state.users[state.currentUser].transactions = state.transactions;
    saveUserData(state.currentUser, state.users[state.currentUser]);
    saveToLocalStorage();
  
    transactionModal.hide();
    updateDashboard();
    renderRecentTransactions();
    renderAllTransactions();
}

// Save category
function saveCategory() {
    const name = document.getElementById('category-name').value.trim();
    const type = document.getElementById('category-type').value;
    const icon = document.getElementById('category-icon').value;
    const color = document.getElementById('category-color').value;
    
    if (!name) {
        alert('Harap masukkan nama kategori');
        return;
    }

    const categoryData = {
        name,
        type,
        icon,
        color
    };

    if (state.editingCategory) {
        // Update existing category
        categoryData.id = state.editingCategory.id;
        const index = state.categories.findIndex(c => c.id === state.editingCategory.id);
        state.categories[index] = categoryData;
    } else {
        // Add new category
        categoryData.id = state.categories.length > 0 
            ? Math.max(...state.categories.map(c => c.id)) + 1 
            : 1;
        state.categories.push(categoryData);
    }

    // Save to user data
    state.users[state.currentUser].categories = state.categories;
    saveUserData(state.currentUser, state.users[state.currentUser]);
    saveToLocalStorage();

    categoryModal.hide();
    renderCategoriesDropdown();
    renderAllCategories();
    updateDashboard();
}
// Render categories dropdown
function renderCategoriesDropdown() {
    const dropdown = document.getElementById('transaction-category');
    if (!dropdown) return; // Guard clause untuk mencegah error jika elemen tidak ditemukan

    dropdown.innerHTML = '<option value="">Pilih Kategori</option>'; // Reset dropdown

    const filteredCategories = state.categories.filter(category => {
        const type = document.querySelector('input[name="transaction-type"]:checked').value;
        return category.type === type; // Hanya tampilkan kategori sesuai jenis transaksi
    });

    filteredCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.name;
        dropdown.appendChild(option);
    });

    // Event listener untuk perubahan jenis transaksi
    document.querySelectorAll('input[name="transaction-type"]').forEach(radio => {
        radio.addEventListener('change', () => {
            renderCategoriesDropdown(); // Update dropdown saat jenis transaksi berubah
        });
    });
}

// Render all categories
function renderAllCategories() {
    const incomeCategoriesList = document.getElementById('income-categories');
    const expenseCategoriesList = document.getElementById('expense-categories');

    if (!incomeCategoriesList || !expenseCategoriesList) return; // Guard clause

    // Clear existing content
    incomeCategoriesList.innerHTML = '';
    expenseCategoriesList.innerHTML = '';

    // Render income categories
    state.categories
        .filter(category => category.type === 'income')
        .forEach(category => {
            const listItem = createCategoryListItem(category);
            incomeCategoriesList.appendChild(listItem);
        });

    // Render expense categories
    state.categories
        .filter(category => category.type === 'expense')
        .forEach(category => {
            const listItem = createCategoryListItem(category);
            expenseCategoriesList.appendChild(listItem);
        });
}

// Create category list item
function createCategoryListItem(category) {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex align-items-center';
    
    li.innerHTML = `
        <span class="category-icon" style="background-color: ${category.color}">
            <i class="fas fa-${category.icon}"></i>
        </span>
        <span class="category-name flex-grow-1">${category.name}</span>
        <div class="category-actions">
            <button class="btn btn-sm btn-outline-primary edit-category" data-id="${category.id}">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger delete-category" data-id="${category.id}">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;

    // Add event listeners for edit and delete
    li.querySelector('.edit-category').addEventListener('click', () => editCategory(category.id));
    li.querySelector('.delete-category').addEventListener('click', () => deleteCategory(category.id));

    return li;
}

// Edit category
function editCategory(categoryId) {
    const category = state.categories.find(c => c.id === categoryId);
    if (!category) return;

    state.editingCategory = category;
    document.getElementById('categoryModalTitle').textContent = 'Edit Kategori';
    document.getElementById('category-name').value = category.name;
    document.getElementById('category-type').value = category.type;
    document.getElementById('category-icon').value = category.icon;
    document.getElementById('category-color').value = category.color;
    categoryModal.show();
}

// Delete category
function deleteCategory(categoryId) {
    // Check if category is used in any transactions
    const isUsed = state.transactions.some(t => t.categoryId === categoryId);
    if (isUsed) {
        alert('Kategori ini digunakan dalam transaksi. Tidak dapat dihapus.');
        return;
    }

    showConfirmation(
        'Hapus Kategori',
        'Apakah Anda yakin ingin menghapus kategori ini?',
        () => {
            state.categories = state.categories.filter(c => c.id !== categoryId);
            state.users[state.currentUser].categories = state.categories;
            saveUserData(state.currentUser, state.users[state.currentUser]);
            saveToLocalStorage();
            renderAllCategories();
            renderCategoriesDropdown();
        }
    );
}

// Update dashboard
function updateDashboard() {
    const { income, expense, balance } = calculateSummary();
    
    // Update summary cards
    document.getElementById('income-amount').textContent = formatCurrency(income);
    document.getElementById('expense-amount').textContent = formatCurrency(expense);
    document.getElementById('balance-amount').textContent = formatCurrency(balance);

    // Update progress bars (contoh: relative to monthly budget)
    const monthlyBudget = state.users[state.currentUser].monthlyBudget || 1000000; // Default Rp1M
    document.getElementById('income-progress').style.width = `${Math.min((income / monthlyBudget) * 100, 100)}%`;
    document.getElementById('expense-progress').style.width = `${Math.min((expense / monthlyBudget) * 100, 100)}%`;
    document.getElementById('balance-progress').style.width = `${Math.min((balance / monthlyBudget) * 100, 100)}%`;

    // Update charts
    updateSpendingChart();
    updateCategoryChart();
}

// Calculate summary based on current period
function calculateSummary() {
    let income = 0;
    let expense = 0;

    const filteredTransactions = filterTransactionsByPeriod(state.transactions);

    filteredTransactions.forEach(transaction => {
        if (transaction.type === 'income') {
            income += transaction.amount;
        } else {
            expense += transaction.amount;
        }
    });

    return {
        income,
        expense,
        balance: income - expense
    };
}

// Filter transactions by current period
function filterTransactionsByPeriod(transactions) {
    const now = new Date();
    let startDate, endDate;

    if (typeof state.currentPeriod === 'object') {
        startDate = new Date(state.currentPeriod.start);
        endDate = new Date(state.currentPeriod.end);
    } else {
        switch (state.currentPeriod) {
            case 'today':
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                break;
            case 'week':
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
                endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay() + 7);
                break;
            case 'month':
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                break;
            case 'year':
                startDate = new Date(now.getFullYear(), 0, 1);
                endDate = new Date(now.getFullYear(), 11, 31);
                break;
            default:
                startDate = new Date(0);
                endDate = new Date();
        }
    }

    return transactions.filter(t => {
        const transactionDate = new Date(t.date);
        return transactionDate >= startDate && transactionDate <= endDate;
    });
}

// Update spending chart
function updateSpendingChart() {
    const ctx = document.getElementById('spendingChart').getContext('2d');
    const filteredTransactions = filterTransactionsByPeriod(state.transactions);
    
    const dailyData = {};
    filteredTransactions.forEach(t => {
        const date = t.date;
        if (!dailyData[date]) {
            dailyData[date] = { income: 0, expense: 0 };
        }
        dailyData[date][t.type] += t.amount;
    });

    const labels = Object.keys(dailyData).sort();
    const incomeData = labels.map(date => dailyData[date].income);
    const expenseData = labels.map(date => dailyData[date].expense);

    if (spendingChart) spendingChart.destroy();

    ```chartjs
    {
        "type": "line",
        "data": {
            "labels": labels,
            "datasets": [
                {
                    "label": "Pemasukan",
                    "data": incomeData,
                    "borderColor": "#1cc88a",
                    "backgroundColor": "rgba(28, 200, 138, 0.1)",
                    "fill": true,
                    "tension": 0.4
                },
                {
                    "label": "Pengeluaran",
                    "data": expenseData,
                    "borderColor": "#e74a3b",
                    "backgroundColor": "rgba(231, 74, 59, 0.1)",
                    "fill": true,
                    "tension": 0.4
                }
            ]
        },
        "options": {
            "responsive": true,
            "maintainAspectRatio": false,
            "scales": {
                "x": {
                    "grid": { "display": false }
                },
                "y": {
                    "beginAtZero": true,
                    "grid": { "color": "rgba(0, 0, 0, 0.05)" }
                }
            },
            "plugins": {
                "legend": { "position": "top" },
                "tooltip": {
                    "backgroundColor": "#2c3e50",
                    "titleFont": { "size": 14 },
                    "bodyFont": { "size": 12 }
                }
            }
        }
    }
    ```

    spendingChart = new Chart(ctx, chartConfig);
}

// Update category chart
function updateCategoryChart() {
    const ctx = document.getElementById('categoryChart').getContext('2d');
    const filteredTransactions = filterTransactionsByPeriod(state.transactions);
    
    const categoryData = {};
    filteredTransactions
        .filter(t => t.type === 'expense')
        .forEach(t => {
            const category = state.categories.find(c => c.id === t.categoryId);
            if (category) {
                categoryData[category.name] = (categoryData[category.name] || 0) + t.amount;
            }
        });

    const labels = Object.keys(categoryData);
    const data = Object.values(categoryData);
    const colors = state.categories
        .filter(c => labels.includes(c.name))
        .map(c => c.color);

    if (categoryChart) categoryChart.destroy();

    ```chartjs
    {
        "type": "doughnut",
        "data": {
            "labels": labels,
            "datasets": [{
                "data": data,
                "backgroundColor": colors,
                "borderColor": "#ffffff",
                "borderWidth": 2
            }]
        },
        "options": {
            "responsive": true,
            "maintainAspectRatio": false,
            "plugins": {
                "legend": { "position": "right" },
                "tooltip": {
                    "backgroundColor": "#2c3e50",
                    "titleFont": { "size": 14 },
                    "bodyFont": { "size": 12 }
                }
            }
        }
    }
    ```

    categoryChart = new Chart(ctx, chartConfig);
}

// Render recent transactions
function renderRecentTransactions() {
    const tbody = document.getElementById('recent-transactions');
    if (!tbody) return;

    const filteredTransactions = filterTransactionsByPeriod(state.transactions)
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 5); // Tampilkan 5 transaksi terakhir

    tbody.innerHTML = '';

    filteredTransactions.forEach(transaction => {
        const category = state.categories.find(c => c.id === transaction.categoryId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${formatDisplayDate(transaction.date)}</td>
            <td>${transaction.description}</td>
            <td class="transaction-${transaction.type}">
                ${formatCurrency(transaction.amount * (transaction.type === 'income' ? 1 : -1))}
            </td>
            <td>${category ? category.name : 'Tidak Diketahui'}</td>
        `;
        tbody.appendChild(tr);
    });
}

// Render all transactions
function renderAllTransactions() {
    const tbody = document.getElementById('all-transactions');
    if (!tbody) return;

    const filteredTransactions = filterTransactionsByPeriod(state.transactions)
        .sort((a, b) => new Date(b.date) - new Date(a.date));

    tbody.innerHTML = '';

    filteredTransactions.forEach(transaction => {
        const category = state.categories.find(c => c.id === transaction.categoryId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${formatDisplayDate(transaction.date)}</td>
            <td>${transaction.description}</td>
            <td>${category ? category.name : 'Tidak Diketahui'}</td>
            <td class="transaction-${transaction.type}">
                ${formatCurrency(transaction.amount * (transaction.type === 'income' ? 1 : -1))}
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary edit-transaction" data-id="${transaction.id}">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger delete-transaction" data-id="${transaction.id}">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    // Add event listeners for edit and delete
    document.querySelectorAll('.edit-transaction').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = parseInt(btn.getAttribute('data-id'));
            editTransaction(id);
        });
    });

    document.querySelectorAll('.delete-transaction').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = parseInt(btn.getAttribute('data-id'));
            deleteTransaction(id);
        });
    });

    // Update pagination (simple version)
    const pagination = document.getElementById('transaction-pagination');
    pagination.innerHTML = `
        <li class="page-item disabled"><a class="page-link" href="#">Sebelumnya</a></li>
        <li class="page-item active"><a class="page-link" href="#">1</a></li>
        <li class="page-item"><a class="page-link" href="#">Berikutnya</a></li>
    `;
}

// Edit transaction
function editTransaction(transactionId) {
    const transaction = state.transactions.find(t => t.id === transactionId);
    if (!transaction) return;

    state.editingTransaction = transaction;
    document.getElementById('transactionModalTitle').textContent = 'Edit Transaksi';
    document.getElementById('transaction-amount').value = transaction.amount;
    document.getElementById('transaction-description').value = transaction.description;
    document.getElementById('transaction-date').value = transaction.date;
    document.getElementById(`type-${transaction.type}`).checked = true;
    renderCategoriesDropdown();
    document.getElementById('transaction-category').value = transaction.categoryId;
    transactionModal.show();
}

// Delete transaction
function deleteTransaction(transactionId) {
    showConfirmation(
        'Hapus Transaksi',
        'Apakah Anda yakin ingin menghapus transaksi ini?',
        () => {
            state.transactions = state.transactions.filter(t => t.id !== transactionId);
            state.users[state.currentUser].transactions = state.transactions;
            saveUserData(state.currentUser, state.users[state.currentUser]);
            saveToLocalStorage();
            updateDashboard();
            renderRecentTransactions();
            renderAllTransactions();
        }
    );
}

// Show confirmation modal
function showConfirmation(title, message, callback) {
    document.getElementById('confirmationModalTitle').textContent = title;
    document.getElementById('confirmationModalBody').textContent = message;
    
    // Remove existing event listeners to prevent duplicates
    const newConfirmBtn = document.getElementById('confirm-action').cloneNode(true);
    document.getElementById('confirm-action').parentNode.replaceChild(newConfirmBtn, document.getElementById('confirm-action'));

    newConfirmBtn.addEventListener('click', () => {
        callback();
        confirmationModal.hide();
    });

    confirmationModal.show();
}

// Export all data
function exportAllData() {
    const data = {
        user: state.users[state.currentUser],
        transactions: state.transactions,
        categories: state.categories
    };

    const worksheet = XLSX.utils.json_to_sheet([data]);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, 'Data');
    XLSX.writeFile(workbook, `FinancialData_${formatDate(new Date())}.xlsx`);
}

// Export report
function exportReport() {
    const filteredTransactions = filterTransactionsByPeriod(state.transactions);
    const reportData = filteredTransactions.map(t => {
        const category = state.categories.find(c => c.id === t.categoryId);
        return {
            Date: formatDisplayDate(t.date),
            Description: t.description,
            Category: category ? category.name : 'Tidak Diketahui',
            Amount: t.amount * (t.type === 'income' ? 1 : -1),
            Type: t.type
        };
    });

    const worksheet = XLSX.utils.json_to_sheet(reportData);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, 'Report');
    XLSX.writeFile(workbook, `FinancialReport_${formatDate(new Date())}.xlsx`);
}

// Render reports
function renderReports() {
    updateComparisonChart();
    updateTrendChart();
    updateDetailedReport();
}

// Update comparison chart
function updateComparisonChart() {
    const ctx = document.getElementById('comparisonChart').getContext('2d');
    const period1 = document.getElementById('report-period-1').value;
    const period2 = document.getElementById('report-period-2').value;

    const data1 = calculatePeriodSummary(period1);
    const data2 = calculatePeriodSummary(period2);

    if (comparisonChart) comparisonChart.destroy();

    ```chartjs
    {
        "type": "bar",
        "data": {
            "labels": ["Pemasukan", "Pengeluaran", "Saldo"],
            "datasets": [
                {
                    "label": period1,
                    "data": [data1.income, data1.expense, data1.balance],
                    "backgroundColor": "rgba(78, 115, 223, 0.5)",
                    "borderColor": "#4e73df",
                    "borderWidth": 1
                },
                {
                    "label": period2,
                    "data": [data2.income, data2.expense, data2.balance],
                    "backgroundColor": "rgba(28, 200, 138, 0.5)",
                    "borderColor": "#1cc88a",
                    "borderWidth": 1
                }
            ]
        },
        "options": {
            "responsive": true,
            "maintainAspectRatio": false,
            "scales": {
                "y": {
                    "beginAtZero": true,
                    "grid": { "color": "rgba(0, 0, 0, 0.05)" }
                }
            },
            "plugins": {
                "legend": { "position": "top" },
                "tooltip": {
                    "backgroundColor": "#2c3e50",
                    "titleFont": { "size": 14 },
                    "bodyFont": { "size": 12 }
                }
            }
        }
    }
    ```

    comparisonChart = new Chart(ctx, chartConfig);

    // Add event listeners for period selectors
    document.getElementById('report-period-1').addEventListener('change', updateReports);
    document.getElementById('report-period-2').addEventListener('change', updateReports);
}

// Calculate summary for a specific period
function calculatePeriodSummary(period) {
    let startDate, endDate;
    const now = new Date();

    switch (period) {
        case 'this_month':
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            break;
        case 'last_month':
            startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            endDate = new Date(now.getFullYear(), now.getMonth(), 0);
            break;
        case 'this_quarter':
            const quarter = Math.floor(now.getMonth() / 3);
            startDate = new Date(now.getFullYear(), quarter * 3, 1);
            endDate = new Date(now.getFullYear(), (quarter + 1) * 3, 0);
            break;
        case 'last_quarter':
            const lastQuarter = Math.floor((now.getMonth() - 3) / 3);
            startDate = new Date(now.getFullYear(), lastQuarter * 3, 1);
            endDate = new Date(now.getFullYear(), (lastQuarter + 1) * 3, 0);
            break;
        case 'this_year':
            startDate = new Date(now.getFullYear(), 0, 1);
            endDate = new Date(now.getFullYear(), 11, 31);
            break;
        case 'last_year':
            startDate = new Date(now.getFullYear() - 1, 0, 1);
            endDate = new Date(now.getFullYear() - 1, 11, 31);
            break;
        default:
            startDate = new Date(0);
            endDate = new Date();
    }

    const filteredTransactions = state.transactions.filter(t => {
        const transactionDate = new Date(t.date);
        return transactionDate >= startDate && transactionDate <= endDate;
    });

    return calculateSummary(filteredTransactions);
}

// Update trend chart
function updateTrendChart() {
    const ctx = document.getElementById('trendChart').getContext('2d');
    const selectedCategoryId = parseInt(document.getElementById('category-trend-select').value);

    const monthlyData = {};
    state.transactions
        .filter(t => t.categoryId === selectedCategoryId)
        .forEach(t => {
            const date = new Date(t.date);
            const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
            monthlyData[monthKey] = (monthlyData[monthKey] || 0) + t.amount;
        });

    const labels = Object.keys(monthlyData).sort();
    const data = labels.map(key => monthlyData[key]);

    if (trendChart) trendChart.destroy();

    ```chartjs
    {
        "type": "line",
        "data": {
            "labels": labels,
            "datasets": [{
                "label": "Pengeluaran",
                "data": data,
                "borderColor": "#4e73df",
                "backgroundColor": "rgba(78, 115, 223, 0.1)",
                "fill": true,
                "tension": 0.4
            }]
        },
        "options": {
            "responsive": true,
            "maintainAspectRatio": false,
            "scales": {
                "x": {
                    "grid": { "display": false }
                },
                "y": {
                    "beginAtZero": true,
                    "grid": { "color": "rgba(0, 0, 0, 0.05)" }
                }
            },
            "plugins": {
                "legend": { "position": "top" },
                "tooltip": {
                    "backgroundColor": "#2c3e50",
                    "titleFont": { "size": 14 },
                    "bodyFont": { "size": 12 }
                }
            }
        }
    }
    ```

    trendChart = new Chart(ctx, chartConfig);

    // Populate category selector
    const select = document.getElementById('category-trend-select');
    select.innerHTML = '';
    state.categories
        .filter(c => c.type === 'expense')
        .forEach(c => {
            const option = document.createElement('option');
            option.value = c.id;
            option.textContent = c.name;
            select.appendChild(option);
        });

    select.addEventListener('change', updateTrendChart);
}

// Update detailed report
function updateDetailedReport() {
    const tbody = document.getElementById('detailed-report');
    const thisMonth = calculatePeriodSummary('this_month');
    const lastMonth = calculatePeriodSummary('last_month');

    const categoryData = {};
    state.categories
        .filter(c => c.type === 'expense')
        .forEach(c => {
            categoryData[c.id] = {
                name: c.name,
                thisMonth: 0,
                lastMonth: 0
            };
        });

    state.transactions.forEach(t => {
        if (t.type !== 'expense') return;
        const date = new Date(t.date);
        const thisMonthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
        const lastMonthStart = new Date(new Date().getFullYear(), new Date().getMonth() - 1, 1);
        const lastMonthEnd = new Date(new Date().getFullYear(), new Date().getMonth(), 0);

        if (date >= thisMonthStart) {
            if (categoryData[t.categoryId]) {
                categoryData[t.categoryId].thisMonth += t.amount;
            }
        } else if (date >= lastMonthStart && date <= lastMonthEnd) {
            if (categoryData[t.categoryId]) {
                categoryData[t.categoryId].lastMonth += t.amount;
            }
        }
    });

    tbody.innerHTML = '';
    Object.values(categoryData).forEach(data => {
        const change = data.thisMonth - data.lastMonth;
        const percentage = thisMonth.expense ? (data.thisMonth / thisMonth.expense * 100).toFixed(1) : 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${data.name}</td>
            <td>${formatCurrency(data.thisMonth)}</td>
            <td>${formatCurrency(data.lastMonth)}</td>
            <td class="${change >= 0 ? 'text-danger' : 'text-success'}">
                ${formatCurrency(change)}
            </td>
            <td>${percentage}%</td>
        `;
        tbody.appendChild(tr);
    });
}

// Generate AI insights
function generateInsights() {
    const insightsContainer = document.getElementById('ai-insights');
    const healthInsights = document.getElementById('financial-health-insights');
    const recommendations = document.getElementById('recommendations-insights');
    
    // Show loading
    insightsContainer.querySelector('.insight-loading').style.display = 'flex';
    healthInsights.querySelector('.insight-loading').style.display = 'flex';
    recommendations.querySelector('.insight-loading').style.display = 'flex';

    setTimeout(() => {
        // Simple AI-like analysis (for demo purposes)
        const { income, expense, balance } = calculateSummary();
        const monthlyBudget = state.users[state.currentUser].monthlyBudget || 1000000;
        const savingsGoal = state.users[state.currentUser].savingsGoal || 20;
        const savingsRate = income ? ((income - expense) / income * 100).toFixed(1) : 0;

        // Financial score
        let score = 50;
        if (expense < income) score += 20;
        if (savingsRate >= savingsGoal) score += 20;
        if (expense <= monthlyBudget) score += 10;
        score = Math.min(100, Math.max(0, score));

        document.getElementById('financial-score').textContent = score;
        document.getElementById('score-circle').style.background = `conic-gradient(#1cc88a ${score}%, #dfe6e9 ${score}%)`;
        document.getElementById('savings-score').style.width = `${Math.min(savingsRate, 100)}%`;
        document.getElementById('spending-score').style.width = `${Math.min((expense / monthlyBudget) * 100, 100)}%`;
        document.getElementById('budgeting-score').style.width = `${expense <= monthlyBudget ? 100 : 50}%`;

        // General insights
        insightsContainer.querySelector('.insight-content').innerHTML = `
            <div class="insight-item">
                <div class="insight-title">Tren Pengeluaran</div>
                <div class="insight-text">
                    Pengeluaran Anda ${expense > income ? 'melebihi' : 'di bawah'} pemasukan. 
                    ${expense > income ? 'Pertimbangkan untuk mengurangi pengeluaran discretionary.' : 'Bagus, Anda menabung dengan baik!'}
                </div>
            </div>
            <div class="insight-item">
                <div class="insight-title">Tingkat Tabungan</div>
                <div class="insight-text">
                    Tingkat tabungan Anda saat ini adalah ${savingsRate}%. 
                    Target Anda adalah ${savingsGoal}%. 
                    ${savingsRate < savingsGoal ? 'Coba tingkatkan tabungan dengan mengurangi pengeluaran kecil.' : 'Pertahankan tingkat tabungan yang baik ini!'}
                </div>
            </div>
        `;

        // Financial health
        healthInsights.querySelector('.insight-content').innerHTML = `
            <div class="insight-item">
                <div class="insight-title">Kesehatan Keuangan</div>
                <div class="insight-text">
                    Skor keuangan Anda adalah ${score}/100. 
                    ${score >= 80 ? 'Keuangan Anda sangat sehat!' : score >= 60 ? 'Keuangan Anda cukup baik, tapi bisa ditingkatkan.' : 'Perhatian diperlukan untuk meningkatkan kesehatan keuangan Anda.'}
                </div>
            </div>
        `;

        // Recommendations
        recommendations.querySelector('.insight-content').innerHTML = `
            <div class="insight-item">
                <div class="insight-title">Rekomendasi</div>
                <div class="insight-text">
                    ${expense > monthlyBudget ? 'Pengeluaran Anda melebihi anggaran. Tinjau kategori pengeluaran seperti makanan atau hiburan.' : 'Pertahankan disiplin anggaran Anda!'}
                    <br>
                    ${savingsRate < savingsGoal ? 'Alokasikan lebih banyak ke tabungan dengan mengotomatiskan transfer bulanan.' : 'Pertimbangkan untuk mengalokasikan tabungan ekstra ke investasi jangka panjang.'}
                </div>
            </div>
        `;

        // Hide loading and show content
        insightsContainer.querySelector('.insight-loading').style.display = 'none';
        healthInsights.querySelector('.insight-loading').style.display = 'none';
        recommendations.querySelector('.insight-loading').style.display = 'none';
        insightsContainer.querySelector('.insight-content').classList.add('show');
        healthInsights.querySelector('.insight-content').classList.add('show');
        recommendations.querySelector('.insight-content').classList.add('show');
    }, 1000); // Simulate API delay
}

// Render user settings
function renderUserSettings() {
    const user = state.users[state.currentUser];
    document.getElementById('user-name').value = user.name || '';
    document.getElementById('user-email').value = user.email || '';
    document.getElementById('user-currency').value = user.currency || 'IDR';
    document.getElementById('monthly-budget').value = user.monthlyBudget || 0;
    document.getElementById('savings-goal').value = user.savingsGoal || 20;
    document.getElementById('notifications-enabled').checked = user.notificationsEnabled !== false;
}

// Save account settings
function saveAccountSettings(e) {
    e.preventDefault();
    const user = state.users[state.currentUser];
    user.name = document.getElementById('user-name').value;
    user.email = document.getElementById('user-email').value;
    user.currency = document.getElementById('user-currency').value;
    
    saveUserData(state.currentUser, user);
    saveToLocalStorage();
    document.getElementById('sidebar-username').textContent = user.name;
    updateDashboard();
    renderRecentTransactions();
    renderAllTransactions();
    alert('Pengaturan akun disimpan');
}

// Save budget settings
function saveBudgetSettings(e) {
    e.preventDefault();
    const user = state.users[state.currentUser];
    user.monthlyBudget = parseFloat(document.getElementById('monthly-budget').value) || 0;
    user.savingsGoal = parseFloat(document.getElementById('savings-goal').value) || 20;
    user.notificationsEnabled = document.getElementById('notifications-enabled').checked;
    
    saveUserData(state.currentUser, user);
    saveToLocalStorage();
    updateDashboard();
    generateInsights();
    alert('Pengaturan anggaran disimpan');
}

// Reset all data
function resetAllData() {
    state.transactions = [];
    state.categories = getDefaultCategories();
    state.users[state.currentUser].transactions = [];
    state.users[state.currentUser].categories = state.categories;
    saveUserData(state.currentUser, state.users[state.currentUser]);
    saveToLocalStorage();
    updateDashboard();
    renderRecentTransactions();
    renderAllTransactions();
    renderAllCategories();
    renderCategoriesDropdown();
    generateInsights();
}

// Update reports (wrapper for all report updates)
function updateReports() {
    updateComparisonChart();
    updateTrendChart();
    updateDetailedReport();
}

// Initialize the app
init();
    </script>
</body>
</html>
